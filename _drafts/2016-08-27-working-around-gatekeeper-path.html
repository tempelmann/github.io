---
layout: post
title: Working around Gatekeeper Path Randomization aka App Translocation
date: '2016-08-27T12:31:00.000+01:00'
author: Thomas Tempelmann
tags: 
modified_time: '2016-08-27T12:31:08.374+01:00'
blogger_id: tag:blogger.com,1999:blog-8797526579651167122.post-5799639619564514966
blogger_orig_url: https://blog.tempel.org/2016/08/working-around-gatekeeper-path.html
---

This is about a new feature in macOS 10.12 "Sierra", based on the most recent developer beta.<br /><br />First, a few references:<br /><br /><a href="https://developer.apple.com/videos/play/wwdc2016/706/" target="_blank">Apple WWDC video:&nbsp;What's New in Security</a>&nbsp;(starting at 23:20 - Repackaging Problem)<br /><br /><a href="http://weblog.rogueamoeba.com/2016/06/29/sierra-and-gatekeeper-path-randomization/">Rogue Amoeba: Sierra and Gatekeeper Path Randomization</a><br /><br /><a href="https://github.com/potionfactory/LetsMove/issues/56" target="_blank">github LetsMove: Detect/disable translocation when moving app on macOS Sierra</a><br /><div><br /></div><h3>Troubles with App Translocation</h3><h4></h4><h4>dmg vs. zip files</h4><div><br /></div><div>Yes, delivery apps in a dmg is a solution, but an unpleasant one, both for the developer (more work) and the user (see comments in Rogue Amoeba's post where several devs explain why they don't like it). So, the following is all about the troubles delivering apps in a zip file, which is very common and has worked pretty well until now.</div><h4></h4><h4>New complications for zipped apps</h4><div><br /></div><div>Apps that need to export their current path, e.g. to add themselves to Login Items, can't do that while running translocated. So they need to get moved first. Which they can do at launch, by detecting they're running translocated, and then asking the user to move the app.</div><div><br /></div><div>Many apps have the ability to move the app automatically to the Applications folder. They do that by launching a separate program (usually a script, e.g. <a href="https://github.com/potionfactory/LetsMove" target="_blank">LetsMove</a>) that moves the app bundle and then relaunches the app at the new location.</div><h4></h4><h4>Self-relocation to Applications folder is not working any more in some cases</h4><div><br /></div><div>However, this long-used procedure fails on 10.12 because existing scripts will be unable to determine the correct location of the app in order to move it - since the app runs translocated, the script will also only see the app in the randomized folder location - and it can't move that one to the Applications folder. It needs to find the original app's location, which may be in the Download folder but isn't necessarily there - and it may not have the default name (e.g. when downloading the app twice, and unzipping both, the second one will have a different name, which will be a problem is both apps are not the same but different versions, for instance). Ergo, there's no safe way for the script to determine the original path of the app it should move.</div><h4></h4><h4>How to solve app relocation</h4><div><br /></div><div>Curiously, though, I ran into a trick that solves this. It's unclear if this is on purpose or a mistake that could be fixed in a later 10.12 release. The trick is to use AppleScript to move the app. Even though AppleScript will not know the original path either, giving this translocated path to the Finder's move command will actually move the app from its original place.</div><h4></h4><h4>Auto-relocated apps remain translocated</h4><div><br /></div><div>However, even when successfully moving the app to the Applications folder using AppleScript, the app keeps getting translocated when launched. This means that telling the Finder to move a file using AppleScript does not clear the "needs translocation" flag that gets cleared when moving the file interactively in the Finder. Whether that's on purpose or not is not clear to me, either.</div><h4></h4><h4>Removing translocation from a relocated app</h4><div><br /></div><div>Well, the funny thing is that the quarantining flags including the "needs translocation" flag can still be modified by a script. So, the trick is to first move the app to the Applications folder and then invoke the "xattr" command to delete the quarantine attribute from the moved application. After that, the moved app can be launched as expected.</div><h4></h4><h4>Is this "legal"?</h4><div><br /></div><div>I don't know if Apple considers this an unwanted hack or if that's a valid solution. It certainly looks like a loophole around all the barriers Apple has put up to prevent an app to get itself out of the translocation mode automagically.</div><div><br /></div>I've tried to get answers from Apple, but I've so far only run into dead ends (it feels like running into a wall, actually). With that, we developers are left in the dark and still don't know if and how we shall deal with these issues where apps simply cannot run from a randomized temporary path.<br /><div><br /></div><h3>More thoughts on needing App Translocation at all</h3><div><br /></div><div>Clearly, the "repackaging problem" Apple talks about in the WWDC video, also known as "dylib hijacking" is about protecting apps that sideload code from around them, e.g. from next to their app's location, by making sure they cannot do so without the user conciously repacking the app and the files that belong next to the app by moving them together to a new location. Makes sense.</div><div><br /></div><div>But isn't Apple overreacting here? Most apps delivered in a zip file do not do any such side-loading. Yet, every app gets punished for it.</div><div><br /></div><div>I and others have therefore pleaded that Apple should give us a new entry in the Info.plist that lets us say: "This app does not do any sideloading", and if that's present, GateKeeper should not need to perform translocation for that app, solving almost everyone's troubles with App Translocation.</div><div><br /></div><div>However, it appears that Apple is not willing to give us this option. Meaning Apple doesn't trust us to do the right thing.</div><div><br /></div><div>But if they don't trust us, shouldn't they also distrust us doing any other malicious thing on the user's computer, such as installing hidden monitoring tools that phone home the user's clipboard, email account and what else one can harvest without needing explicit authorization?</div><div><br /></div><div>Apple can't control everything, but they have one a leash on us: The certificate that we use to sign our apps with. If we do something really bad, Apple could invalidate our cert and then our apps will soon not run on any up-to-date Mac any more. That's the best practical security concept the users have when having to trust the app makers. Apple's GateKeeper relies on this certificate, mainly.</div><div><br /></div><div>Apple has to trust us devs not to do bad things in the code we write. Apple also has a handle on us if we screw up, by being able to recall our certificates. So, why can't Apple also trust us if we say that we do not do side loading of code? What's the reasoning here?</div><div><br /></div><div>I mean, they basically say: No, we don't trust you that you can keep your code safe. But we trust the unsuspecting naive user that he/she can tell when a downloaded zip contains additional files that don't belong there.</div><div><br /></div><div>Because, if I would hack a zip file that contains an app that actually does sideload code and add some hihacking code to it, I'd also add a little note that tells the user to move the app to a new location along with my hijacking code files. And that effectively disables Translocation.</div><div><br /></div><div>The only real solution to this is to not allow sideloading at all. But that can't be enforced. But adding a lame "user needs to know he may move only the app but not these suspicious additional files next to it" protection that can easily be tricked is not. Instead, it's pain and slap into every developer's face.</div><div><br /></div>