---
layout: post
title: 'Xojo: How to improve performance when using WeakRefs'
date: '2017-03-28T16:33:00.001+01:00'
author: Thomas Tempelmann
tags: 
modified_time: '2017-03-28T16:43:37.989+01:00'
blogger_id: tag:blogger.com,1999:blog-8797526579651167122.post-8549131298726260763
blogger_orig_url: https://blog.tempel.org/2017/03/using-weakref-in-xojo-heres-how-to-keep.html
---

If you're building tree structures with leaves (children) that shall keep a reference to their branch (ancestor, parent) they're attached to, the simplest (but not smart) solution is to store a direct references to the parent object in the child object.<br /><br />Imagine this node class:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">class Person</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; property name as String</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; property parent as Person</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; property children() as Person</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">end class</span><br /><br />And then you'd have a Constructor like this:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">sub Constructor (parentIn as Person, nameIn as String)</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; self.parent = parentIn</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; self.name = nameIn</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">end sub</span><br /><br />and create new children like this:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">sub AddAChildNamed (name as String)</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; dim newChild as new Person (self, name)</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; self.children.Append newChild</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">end sub</span><br /><br />This is not optimal because you'd get circular references (parent references children who in turn reference back their parent). And since Xojo uses ref-counting for keeping its objects alive, and does not have a separate garbage collection task, removing all references from your main code to the top parent won't free all those Person objects, because they still keep referencing each others, thereby keeping themselves alive.<br /><br />One solution would be to add a "FreeAllChildren" method that you'd have to call right before are ready to release the entire tree, but that's not very elegant (it's the fatest solution, though, if you get this right).<br /><br />A more natural and fool-proof way is to use weak references for the child-to-parent connections, like this:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">class Person</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; property name as String</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; property parent as WeakRef // **changed**</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; property children() as Person</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">end class</span><br /><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">sub Constructor (parentIn as Person, nameIn as String)</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; self.parent = new WeakRef (parentIn)</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; self.name = nameIn</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">end sub</span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;">To access the actual parent, you'd use code like this to temporarily re-create a hard reference to the parent object:</span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; dim myParent as Parent = Parent (self.parent.Value)</span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;">With the above changes, you won't have circular references any more.</span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;">However, it's not very efficient. If you have many 1000s of parent objects, you'll get as many WeakRef objects. And the downside of WeakRef is that it involves a search operation to locate the actual parent object when you use the </span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">WeakRef.Value</span><span style="font-family: inherit;"> function. And the more WeakRef objects you have, the more time it takes to look up these values.</span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;">Now consider this: Usually, with these parent-child relationships, there are more children to a parent than vice versa. In the above code, every child creates a WeakRef, often for the same Parent. And that's what we can optimize for:</span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;">Instead of having the child create its own WeakRef, let us have the parent provide it, as it'll remain constant.</span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;">Change the constructor to accept a WeakRef:</span></div><div><span style="font-family: inherit;"><br /></span></div><div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">sub Constructor (parentRefIn as WeakRef, nameIn as String)</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; self.parent = parentRefIn</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; self.name = nameIn</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">end sub</span></div></div><div><br />add a new property to the class:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">class Person</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; property selfRef as WeakRef</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; ...</span><br /><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div>and update the way a child gets added accordingly:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">sub AddAChildNamed (name as String)</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; if selfRef = nil then selfRef = new WeakRef (self)</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; dim newChild as new Person (selfRef, name)</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; self.children.Append newChild</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">end sub</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div><div><span style="font-family: inherit;">And that's all.</span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;"><b>TL;DR</b></span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;">If you use WeakRefs, and if you create many WeakRef for the same object, consider creating the WeakRef only once and cache it, to gain runtime performance.</span></div><div><span style="font-family: inherit;"><br /></span></div>