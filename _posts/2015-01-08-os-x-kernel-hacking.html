---
layout: post
title: OS X Kernel Hacking (fixing the psignal kernel bug)
date: '2015-01-08T00:48:00.000Z'
author: Thomas Tempelmann
tags:
- Security
- OS X
- Kernel
- Sandboxing
modified_time: '2015-01-08T09:21:55.283Z'
blogger_id: tag:blogger.com,1999:blog-8797526579651167122.post-5573165824721382637
blogger_orig_url: https://blog.tempel.org/2015/01/os-x-kernel-hacking.html
---

At the German Macoun conference in Oct 2014 I gave a talk about rootkits and hacking the OS X kernel.<br /><br />This article is a summary and follow-up on this topic.<br /><br /><h3>Introduction</h3><br />Since Yosemite (OS X 10.10),&nbsp;kernel extensions (KEXTs) need to be code signed or they won't get loaded any more. The code signing certificate needs to be optained from Apple, and it's not easy to get it - and even if you have one - once you do something with it that Apple doesn't approve of, they can simply invalidate it, preventing further use of KEXTs signed with that certificate.<br /><br />As usual for Apple in recent years, we developers (at least in my case who received said certificate from Apple) are not told clearly what would be acceptable by Apple. Clearly, Apple should use this to block malicious software from getting installed (such as rootkits and "jailbreaks" that undermine the security of the user's data and resources). But what about things that benefit users but that Apple simply does not agree with due to their desire to control everything lately? Is patching bugs allowed? Is patching features allowed as long as it's desired by and beneficial to the users, with their express agreement? We don't know. But we'll find out a bit of that, I guess. See below.<br /><br />It is possible to disable the signing requirement for KEXTs, though. This is done by setting a particular firmware parameter (<a href="http://apple.stackexchange.com/questions/163059/" target="_blank">see this StackExchange answer for instructions</a>) on the computer where you like to load an unsigned KEXT. This setting is meant for developers so that they can test their KEXT without having to sign it each time (besides, performing code signing requires an internect connection, which may not always be available). But users can apply this setting as well, of course. For example, anyone having installed a 3rd-party SSD into their Mac may want to install a patched version of the disk driver in order to <a href="http://www.cindori.org/software/trimenabler/" target="_blank">have TRIM support enabled</a> (Apple only enables it for their own drives by default).<br /><br /><h3>Patching a little bug in the Kernel</h3><br />There's this&nbsp;<a href="http://research.swtch.com/macpprof" target="_blank">bug in the kernel that affects signal handling in threads</a>. The author of the article, Russ Cox, shows how to patch the kernel file on disk to fix this bug. That is a bit dangerous because, when one makes a mistake and tries to boot this system, the Mac may become inoperational, and fixing this is a bit tricky. Also, it's not everyone's pleasure to patch the kernel the way.<br /><br />I now like to show how to perform the same patch dynamically, from within a kernel extension. The advantage of this procedure is that it can be enabled and disabled at will, simply by loading and unloading the KEXT. As it doesn't modify the kernel on disk but only updates it in memory, it should work with future kernel updates as well, patching the bug in there as long as it hasn't been fixed by Apple. Should the bug not be found by the KEXT, then the KEXT simply quits and doesn't alter the system further.<br /><br />To make this work several 3rd party components are used:<br /><br />1. For locating non-exported kernel symbols in memory: The&nbsp;<a href="http://www.phrack.org/papers/revisiting-mac-os-x-kernel-rootkits.html" target="_blank">Flying Circus framework</a>.<br />2. For locating the to-be-patched code in possibly any kernel version without having to know the exact location or code for each kernel release. This is accomplished by using the <a href="http://ragestorm.net/distorm/" target="_blank">diStorm3</a>&nbsp;disassembler.<br /><br />The entire project can be downloaded here:<br /><a href="http://files.tempel.org/OSX-psignal-fix/OSX-psignal-fix.zip">http://files.tempel.org/OSX-psignal-fix/OSX-psignal-fix.zip</a><br /><br />It contains an Xcode project with two targets: One builds the KEXT, the other builds the test program as provided by Russ Cox on this website. It also contains a readily usable KEXT signed with my own certificate.<br /><br />To install the psignal fix into your OS X system, open Terminal and issue the following commands:<br /><br /><span style="font-family: Courier New, Courier, monospace;">cd&nbsp;<i>/path/to/OSX-psignal-fix-folder</i></span><br /><span style="font-family: Courier New, Courier, monospace;">sudo chown -R 0:0 psignal-fix.kext</span><br /><span style="font-family: Courier New, Courier, monospace;">sudo kextload psignal-fix.kext</span><br /><br />That should have installed the patch. If you got an error, open Console.app and look for error messages containing "[psignal-fix]".<br /><br />If you're happy with the functionality of the fix, you may also simply place it into /Library/Extensions/ and reboot to load it permanently. You have have to issue the chown command again after copying the kext to that folder, though.<br /><br />To unload the KEXT, issue this command:<br /><br /><span style="font-family: Courier New, Courier, monospace;">sudo kextunload psignal-fix.kext</span><br /><div style="font-family: Courier; font-size: 10px;"><br /></div>If you have Xcode installed, you can also run the test to verify that the patch works. Open the project and select the "psignal-test" target from the popup menu in the window title. Run it and see its console output. This is the essential output without the fix:<br /><br /><div style="font-family: Menlo;"><b>...</b></div><div style="font-family: Menlo;"><b>500 signals received.</b></div><div style="font-family: Menlo;"><b>500 on main</b></div><div style="font-family: Menlo;"><b>0 on looper 0</b></div><div style="font-family: Menlo;"><b>0 on looper 1</b></div><div style="font-family: Menlo;"><b>0 on looper 2</b></div><div style="font-family: Menlo;"></div><div style="font-family: Menlo;"><b>0 on looper 3</b></div><div><b><br /></b></div>And this is the output with the fix working:<br /><br /><div style="font-family: Menlo;"><b>...</b></div><div style="font-family: Menlo;"><b>500 signals received.</b></div><div style="font-family: Menlo;"><b>0 on main</b></div><div style="font-family: Menlo;"><b>129 on looper 0</b></div><div style="font-family: Menlo;"><b>123 on looper 1</b></div><div style="font-family: Menlo;"><b>128 on looper 2</b></div><br /><div style="font-family: Menlo;"><b>122 on looper 3</b></div><div><b><br /></b></div>The difference is that with the fix intact, the signals will occur nearly evenly distributed on all looper threads and none on the main thread.<br /><br />If you build the KEXT (target "psignal-fix") yourself, you need to disable the KEXT signing requirement first if you're on OSX 10.10 or later, unless you have your own KEXT signing certificate, of course.<br /><br /><h3>References</h3><div><br /></div>* Disable KEXT signing requirement : <a href="http://apple.stackexchange.com/questions/163059/">http://apple.stackexchange.com/questions/163059/</a><br />* Trim Enabler:&nbsp;<a href="http://www.cindori.org/software/trimenabler/">http://www.cindori.org/software/trimenabler/</a><br />* Description of kernel bug: <a href="http://research.swtch.com/macpprof">http://research.swtch.com/macpprof</a><br />* The Flying Circus:&nbsp;<a href="http://www.phrack.org/papers/revisiting-mac-os-x-kernel-rootkits.html">http://www.phrack.org/papers/revisiting-mac-os-x-kernel-rootkits.html</a><br /><br />