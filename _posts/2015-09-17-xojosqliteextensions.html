---
layout: post
title: 'Xojo SQLite databases: Enabling ICU for full Unicode support and adding custom
  functions'
date: '2015-09-17T20:24:00.001+01:00'
author: Thomas Tempelmann
tags:
- Database
- SQLite
- Xojo
modified_time: '2016-07-04T11:47:23.583+01:00'
blogger_id: tag:blogger.com,1999:blog-8797526579651167122.post-5057504788860802586
blogger_orig_url: https://blog.tempel.org/2015/09/xojosqliteextensions.html
---

<h2><span style="font-weight: normal;">Unicode Support (ICU)</span></h2><br />Xojo's default Database class <i style="font-weight: bold;">REALSQLDatabase</i> (or its replacement&nbsp;<i style="font-weight: bold;">SQLiteDatabase</i>), which is based on <a href="https://www.sqlite.org/" target="_blank">sqlite</a>, does not support international (non-english) characters. For instance, if you try to use the SQL function <b style="font-style: italic;">upper</b>&nbsp;on a french phrase such as&nbsp;<i>Tête-à-Tête</i>, you will get&nbsp;<i>TêTE-à-TêTE</i>, i.e. only the plain ASCII chars (a-z) will get uppercased but not the special french chars. This missing unicode support also affects sorting and related comparison functions.<br /><br />The usual solution to this is to compile the sqlite3 library with <a href="http://site.icu-project.org/" target="_blank">ICU</a> support and then include this lib in your program. This is not a viable option with Xojo because you'd also have to write your own Database plugin to make the sqlite lib usable in Xojo (while the sqlite lib is open source, Xojo's plugin is not, or this would be less of an issue). Furtunately, though, Xojo's plugin allows dynamic loading of <a href="https://www.sqlite.org/loadext.html" target="_blank">extensions</a> (like plugins) into the sqlite engine.<br /><br />Still, you need to have a readily built ICU lib for sqlite before you can load it. And unfortunately, there is none publically available as far as I could see, at least not for OS X. Therefore, I'm making my own built version available, along with the source code. Mind you, only for OS X, though, as I do not have the time to make and test versions for Windows and Linux as well. I believe, however, that you can more easily find .dll and .so files of the ICU-sqlite lib on the web and use them with these instructions.<br /><br /><h2><span style="font-weight: normal;">Custom SQL Functions</span></h2><div><br />I recently also started using sqlite's <a href="https://www.sqlite.org/fts3.html" target="_blank">FTS</a> (<i>Fast Text Search</i>) functionality. At the end of the FTS page, examples are shown on how to implement a smart ranking feature when searching for text. To implement it, a custom <i>ranking</i>&nbsp;function needs to be added to the SQL engine. Again, this is usually done by writing C code, and then load that as an extension. But since my code that controls what needs ranking is written in Xojo, I'd need to have this ranking function written in Xojo as well, in order to have access to the other data I've collected in my program relevant to performing the ranking.</div><div><br /></div><div>Adding a custom functions to sqlite is fairly easy: Invoke the SQL command "SELECT load_extension('libfile_path', 'init_function_name')" is all it takes.</div><div><br /></div><div>It would be great if we could simply pass the path to own code that's been compiled by Xojo, along with a custom init function we've prepared for this. Unfortunately, that doesn't work because all methods in Xojo are local (non-exported), making it impossible for sqlite to find any functions in our code.</div><div><br /><h3>Extension Stub</h3></div><div><br />We need to use a small helper code file that provides the init function we need to implement. Here's the C code (I've removed some of the non-essential parts):</div><div><br /></div><pre>    #include &lt;sqlite3ext.h&gt;<br />    SQLITE_EXTENSION_INIT1<br /><br />    typedef __cdecl int (*callback_func) (const void *pApi, void *db);<br /><br />    static callback_func callback;<br /><br />    void SetCallback(void *p) {<br />        callback = p;<br />    }<br /><br />    int sqlite3_extension_init (<br />      sqlite3 *db,<br />      char **pzErrMsg,<br />      const sqlite3_api_routines *pApi)<br />    {<br />        SQLITE_EXTENSION_INIT2(pApi);<br />        if (callback) {<br />            callback (pApi, db);<br />        }<br />        return SQLITE_OK;<br />    }</pre><div><br /></div>The first relevant part here is the <b>SetCallback</b> function. This is a function we'll call from Xojo before loading this extension into the sqlite engine. We pass it the address of a Xojo function in which we'll handle the installation of our custom functions. The SetCallback function stores the address of our Xojo function for later use. Then, once we load this extension using the "SELECT load_extension" command, <b>sqlite3_extension_init</b> will get called. Its code then invokes our previously set Xojo function through the stored callback function pointer. That's basically all it does.<br /><br />(This code should be portable for Windows and Linux as well - the actual source code contains some extra instructions for Windows DLLs).<br /><br />Once the extension gets loaded and our callback function gets called, we perform the registration of the custom functions. How that's done is documented in the <a href="https://www.sqlite.org/c3ref/create_function.html" target="_blank">SQLite docs</a>.<br /><br /><h3>Using the sqlite API</h3><br />There is another challenge, though. Our custom function certainly wants to be able to receive parameters, return values and maybe even perform database access operations on its own. For this, sqlite provides a large <a href="https://www.sqlite.org/c3ref/funclist.html" target="_blank">set of functions</a>&nbsp;through its API.&nbsp;The problem is: While it's fairly easy to invoke them from C code, it's rather tedious to do in Xojo, because they're accessed through an array of function pointers (note the <i>pApi</i>&nbsp;parameter the <i>sqlite3_extension_init</i> gets passed - that's where all those pointers are located). In C, macros take care of making them convenient to call, but in Xojo it means a bit more work for us.<br /><br />Basically, to call a function, e.g.&nbsp;<i><a href="https://www.sqlite.org/c3ref/result_blob.html" target="_blank">sqlite3_result_int</a></i>, we must first find out which place its function pointer occupies in said array. And that can only be found out by looking at the header file (<i>sqlite3ext.h</i>) and counting through the positions. Turns out that <i>sqlite3_result_int</i>&nbsp;is at index 82, for instance.<br /><br />I have then located some of the other functions to access passed parameters and to set returned results and make proxy functions for them to make calling them easier. It should also make it clear how to add more API functions if needed.<br /><br /><h2>Download it all</h2><div><br /></div>To sum this all up, I'm now presenting to you a ready-made Xojo project along with compiled libs for both extensions and their source code with Xcode project files. The project shows how to load both extensions and then tests the results, proving that both the unicode extension and the added custom functions work. Note, however, that it only works on OS X out of the box. I've tested it with both Real Studio 2012r2.1 and Xojo 2015r2.2.<br /><br />The proejct uses the older REALSQLDatabase class. If you replace it with the newer&nbsp;SQLiteDatabase class, you need to also add this line each time before you try to install an exension, or you'll get an "Not authorized" error:<br /><br /><pre>db.LoadExtensions = true</pre><br />I believe the extensions can also be built for Windows and Linux without too much effort if you follow the <a href="https://www.sqlite.org/loadext.html" target="_blank">sqlite instructions</a>&nbsp;under the topic "Compiling A Loadable Extension". If you succeed in this and like to share your results, I'm happy to include them in my downloadable file or link to yours.<br /><br />As usual, my demo code is free of restrictions. Use it as you like.<br /><br /><a href="http://files.tempel.org/RB/SQLite%20Extensions%20Demo.zip" target="_blank">Download here</a>.<br /><br /><br /><h2>Alternative by MonkeyBread Software</h2><div></div>MonkeyBread Software has recently added <a href="https://www.mbsplugins.de/archive/2016-07-02/SQLite_313_with_ICU" target="_blank">ICU support to their SQLite plugin</a> as well.<br /><br />