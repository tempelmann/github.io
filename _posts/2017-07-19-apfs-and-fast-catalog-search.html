---
layout: post
title: APFS and fast catalog search
date: '2017-07-19T20:03:00.000+01:00'
author: Thomas Tempelmann
tags:
- APFS
- Find Any File
- Apple
- OS X
modified_time: '2017-10-03T14:56:06.236+01:00'
blogger_id: tag:blogger.com,1999:blog-8797526579651167122.post-5042867149831784506
blogger_orig_url: https://blog.tempel.org/2017/07/apfs-and-fast-catalog-search.html
---

This is about <b>FSCatalogSearch</b> / <b>searchfs</b> support in macOS with the APFS file system.<br /><br /><b>Updated 3 Oct 2017:</b>&nbsp;Find Any File 1.9 will support fast search on APFS on High Sierra (10.13) by using the <i>searchfs</i> function. Version 1.9 is currently in open beta, see the <a href="http://apps.tempel.org/FindAnyFile/" target="_blank">FAF web site</a>.<br /><div><br /></div><b>Updated 25 July 2017:</b> Clarified why FSCatalogSearch doesn't work on APFS, adds issue about hard links and 64 bit CNID resolving.<br /><br /><h2>Some background on FSCatalogSearch in general</h2><br />Programs like <a href="http://www.devontechnologies.com/products/freeware.html" target="_blank">EasyFind</a> and my own <a href="http://apps.tempel.org/iBored" target="_blank">Find Any File</a>&nbsp;(FAF) are able to search for file names (as well as file dates, sizes and a few other rarely needed attributes) on disks in a quite fast manner by using a little-known function macOS offers.<br /><br />This <i>Carbon level</i> function is known as CatSearch or (FS)<a href="https://developer.apple.com/documentation/coreservices/1565862-fscatalogsearch" target="_blank">CatalogSearch</a> and has been around for more than 25 years. There's also a <i>BSD level</i> function called searchfs.<br /><br />The advantage of this function is that it performs the search for names at the file system driver level, meaning that when you search for files containing ".png" in their name, the file system can look at the entire directory tree much faster, sorting out the matches, and only report those to the program that initiazes the search and then shows the results to the user.<br /><br />Without this special function, the search program would have to start at the root of the disk, read each folder (directory) recursively, and then sort out the matches itself, which all takes <i>much</i> more computing time.<br /><br />For example, a search on a disk with millions of files and folders on it would take only a few seconds with FSCatalogSearch, whereas a classic recursive search would take minutes.<br /><br /><h4></h4><h3>Getting even more technical</h3><br />Apple added the FSCatalogSearch function in Mac OS long ago, after introducing the HFS file system. This was supported by the fact that &nbsp;HFS did, unlike Window's FAT, arrange the entire directory tree in one large file on the disk, with interlinked nodes that did not match the hierarchical folder structure. FSCatalogSearch would then iterate over the nodes in a most efficient way, not caring about the folder structure, thereby minimizing disk seek times, which was a significant factor in disk access before SSDs. This also meant that FSCatalogSearch would only work on volume formats that used a single (invisible) file for its entire directory tree, meaning that FSCatalogSearch was never available for FAT disks, for instance. It would also be optimal for NTFS volumes, but since Apple never used NTFS other than to support reading from Bootcamp partitions, they never made the effort to add FSCatalogSearch to their NTFS file system driver.<br /><br /><h2>What about APFS?</h2><br />Now Apple is about to replace HFS(+) with APFS on macOS. And fans of EasyFind and FAF start wondering: Will I still be able to perform fast disk-wide file name searches the way I'm used to?<br /><br />The good news is: The APFS file system code has support for the lower level searchfs function, and that's been already added in 2016, apparently, for OS X 10.12. Which ultimately means: Yes, FAF and EasyFind can continue to provide fast search on APFS formatted disks, provided extra work is put into updating the apps accordingly.<br /><br />However, there are still some issues:<br /><ul><li>The high-level&nbsp;FSCatalogSearch does not work on APFS. Both EasyFind and FAF rely on this function and therefore won't find files the fast way on APFS volumes right now. The reason for this is that APFS uses larger values (64 bit) than HFS+ for identifying the files, and the FSCatalogSearch function cannot handle those larger values. (<a href="rdar://problem/33454922" style="border: 0px; color: #444488; font-family: Helvetica; font-size: 14px; margin: 0px; outline: 0px; padding: 0px; text-decoration-line: none; text-size-adjust: auto; vertical-align: baseline;">rdar</a><span style="background-color: white; color: #101010; font-family: &quot;helvetica&quot;; font-size: 14px;">://</span><a href="https://openradar.appspot.com/33454922" style="border: 0px; color: #444488; font-family: Helvetica; font-size: 14px; margin: 0px; outline: 0px; padding: 0px; text-decoration-line: none; text-size-adjust: auto; vertical-align: baseline;">33454922</a>)</li><li>As of now (10.12.6, 10.13 beta 3), the searchfs function does search case-sensitive and not&nbsp;case-<i>in</i>sensitive as it should. That means that searching for ".png" won't find files using ".PNG". I confirmed this with an Apple engineer - it's a known issue, just one with a low priority right now. So, there's a chance that this will get resolved eventually, and I hope it'll be done before 10.13 is released. This issue may not get fixed for 10.12.x, though. We'll have to see what Apple does in this regard. (<a href="https://openradar.appspot.com/33455597">rdar://33455597</a>)</li><li>Hard links can't be identified correctly - if there are multiple hard links to the same file, then searchfs can't currently tell them apart, and the results will all point to the same directory entry. (<a href="rdar://problem/33473247" style="border: 0px; color: #444488; font-family: Helvetica; font-size: 14px; margin: 0px; outline: 0px; padding: 0px; text-decoration-line: none; text-size-adjust: auto; vertical-align: baseline;">rdar</a><span style="background-color: white; color: #101010; font-family: &quot;helvetica&quot;; font-size: 14px;">://</span><a href="https://openradar.appspot.com/33473247" style="border: 0px; color: #444488; font-family: Helvetica; font-size: 14px; margin: 0px; outline: 0px; padding: 0px; text-decoration-line: none; text-size-adjust: auto; vertical-align: baseline;">33473247</a>)</li><li>searchfs() returns CNIDs (Catalog Node IDs, 64 bit wide) instead of paths to the found items. This requires resolving these IDs to the paths later. However, there is currently no documented API provided in macOS to do so. There's a hackish way around this, but that's not a proper solution. (<a href="rdar://problem/33507188" style="border: 0px; color: #444488; font-family: Helvetica; font-size: 14px; margin: 0px; outline: 0px; padding: 0px; text-decoration-line: none; text-size-adjust: auto; vertical-align: baseline;">rdar</a><span style="background-color: white; color: #101010; font-family: &quot;helvetica&quot;; font-size: 14px;">://</span><a href="https://openradar.appspot.com/33507188" style="border: 0px; color: #444488; font-family: Helvetica; font-size: 14px; margin: 0px; outline: 0px; padding: 0px; text-decoration-line: none; text-size-adjust: auto; vertical-align: baseline;">33507188</a>)</li></ul><h3></h3><h3>What this all means</h3><div><b><br /></b><b>Current versions of FAF and EasyFind can't fast search on APFS. They need to be rewritten using the searchfs API.</b></div><div><br /></div><div>I will be working on a quick-fix version of FAF that'll add fast search on APFS and which I hope to release before 10.13 (High Sierra) is officially released. I have quite a few other improvements for FAF in the works (64 bit app, content search, icon view, server support etc.) which will have to wait so that I can get this APFS issue resolved ASAP.</div><div><br /></div>