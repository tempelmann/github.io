---
layout: post
title: Performance considerations when reading directories on macOS
date: '2019-04-22T03:01:00.002+01:00'
author: Thomas Tempelmann
tags:
- APFS
- Find Any File
- OS X
modified_time: '2019-05-11T16:35:37.489+01:00'
blogger_id: tag:blogger.com,1999:blog-8797526579651167122.post-7070975415778924769
blogger_orig_url: https://blog.tempel.org/2019/04/dir-read-performance.html
---

<i><b>(Latest update: 11 May 2019, see end of text)</b></i><br /><br />I'm developing (and selling) a fairly popular file search program for the Mac called <a href="http://apps.tempel.org/FindAnyFile/" target="_blank">Find Any File</a>, or just FAF.<br /><br />It works differently from Spotlight, the Mac's primary search tool, in that it always scans the live file system instead of using a database. This makes it somewhat slower in many cases, but has the advantage that it looks at every file on the targeted disk (whereas Spotlight skips system files by default, for instance).<br /><br />My primary goal is to make the search as fast as possible.<br /><br /><h2>Fast search built into macOS</h2><br />Until recently, this went quite well, because Mac disks (volumes) were formatted in HFS+ (aka Mac OS Extended), and Apple provides a special file search operation (<i>CatalogSearch</i> or <a href="https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man2/searchfs.2.html" target="_blank">searchfs</a>) for these volumes, by which FAF could ask for the file name the user is looking for, and macOS would search the volume's directory on itself and only return the matching files. This is very fast.<br /><br />Unfortunately, with Apple's new file system APFS, and the fact that any macOS running High Sierra or Mojave got their startup volume converted from HFS+ to APFS, search performance has decreased by factor 5 to 6! Where searching the entire startup disk for a file like "hosts" did take just 5 seconds on a fast Mac with a HFS volume, it now takes half a minute or more on APFS.<br /><br />Besides, the old network file server protocol AFP does also support the fast search operation, but only on real Mac servers - some NAS systems pretend to support this as well, but my experience shows that this is very unreliable. The newer SMB protocol, OTOH, does not appear to support <i>searchfs</i>.<br /><br /><h2>Searching the classic way</h2><br />When the <i>searchfs</i>&nbsp;operation is not available, unreliable or inefficient, FAF falls back to looking at every directory entry itself, looking for matches to the search, then looking at the contents of every subdirectory, and so on. This is called a recursive search (whereas <i>searchfs</i> performs a flat search over all directory entries of a volume).<br /><br />There are several ways to read these directories. I'll list the most interesting ones:<br /><br /><ul><li>-[NSFileManager contentsOfDirectoryAtURL:includingPropertiesForKeys:options:error:]</li><li>opendir() &amp; readdir_r()</li><li>getattrlistbulk()</li><li>fts_open() &amp;&amp; fts_read()</li></ul><div><br /></div><div>The first is the standard high-level (Foundation) function. It lets you choose which attributes (besides the file name) it shall fetch alongside. This is useful if you want to look at the file sizes, for instance. If you let them fetch along, it'll cache them in the NSURL objects, thereby increase performance if you call <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">[NSURL&nbsp;getResourceValue]</span> later to read the value.</div><div><br /></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">readdir()</span>&nbsp;is a very old UNIX / POSIX function to read a directory's file names, and nothing else, one by one.</div><div><br /></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">getattrlistbulk()</span>&nbsp;is a special Mac BSD function that's an extension to the older&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">getattrlist()</span>. It is supposed to be optimized for faster reading, as it can fetch the entire contents of a directory at once, along with attributes such as file dates and sizes. <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">[NSFileManager contentsOfDirectoryAtURL...]</span> supposedly uses this function, thereby making use of its performance advantage.<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">fts_open()</span> is a long-existing BSD or POSIX function that is specialized on traversing directory trees. I've added this only after the initial tests, i.e. its discussion is a bit more brief below.<br /><br /></div><h2>Test methods</h2><div><br /></div><div>I've tried to find out <b>which of the various methods of reading directories, looking only for file names, is the fastest</b>: I had to scan the same directory tree with every method separately.</div><div><br /></div><div>Testing performance is a bit difficult because <b>macOS tends to cache</b> recently read directories for a short while. For instance, the first time I scan a directory tree with a 100,000 items, it may take 10s, and when I run the same test again withing a few seconds, it'll take only 2s. If I wait half a minute, it may again take 10s. And if I'm searching on a file server, that server may also cache the information in RAM. For instance, my NAS, equipped with Hard Disks, will be rather loud the first time I search on it, due to the HDs performing lots of seeking, whereas a repeat search will make hardly any noise due to little to no seeking, which also increases the search performance.</div><div><br /></div><div>Therefore, <b>I performed the tests twice in succession</b>: Once after freshly mounting the target volume (so that the cache was clear) and once again right after. This would give me both the worst and best case performances. I repeated this several times and averaged the results.</div><div><br /></div><div>I also had to test on different media (e.g. fast SSD vs. slower HD) and formats (HFS+, APFS, NTFS) and network protocols (AFP vs. SMB, from both a NAS and another Mac) because they all behave quite differently.<br /><br />The Xcode project I used for timing all three scanning functions can be <a href="http://files.tempel.org/Various/DirScanner.zip">downloaded here</a>.</div><div><br /></div><h2>Test results</h2><div><br /></div><div>Most tests were performed on macOS 10.13.6. The NAS is a Synology&nbsp;DS213j with firmware DSM 6.2.1, connected over 1 GBit Ethernet, and both AFP and SMB tests were made on the same NAS directory. The Terminal cmd&nbsp;<span style="background-color: white; font-family: &quot;menlo&quot;; font-size: 12px;">"smbutil statshares -a"</span>&nbsp;indicates that the latest SMB3 protocol was used. The remote Mac ran macOS 10.14.4, and the targeted directory on it was on a HFS+ volume so that I could compare performance between AFP and SMB (APFS vols can't be shared over AFP). I also did a few tests on the 10.14.4 Mac, though I only recorded the best case results as the others were difficult to create (I'd have had to reboot between every test and I wasn't too keen on that).</div><div><br /></div><div><div>I was expecting that&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">contentsOfDirectoryAtURL&nbsp;</span>would always be as fast as its low level version&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">getattrlistbulk</span>, whereas&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">readdir</span>&nbsp;would be slower as it wasn't optimized for this purpose. Surprisingly, this was not always the case. (I did not include the fts method when I did this run of tests - its results will instead be discussed in a separate chapter below).</div></div><div><br /></div><div>The values show passed time in seconds for completing a search of a deep folder structure. The values are only comparable in each line, but not across lines, because the folder contents were different. The exception are the network volumes, where the same folders were used for AFP and SMB.</div><div><br /></div><div>The green fields point out the best results. The red one points out an anomaly.</div><div><br /></div><div><table cellpadding="0" cellspacing="0" style="border-collapse: collapse; color: black;"><tbody><tr><td style="background-color: #bec0bf; border: 1px solid rgb(0, 0, 0); height: 11px; padding: 4px; width: 78px;" valign="top"><div style="font-family: Helvetica; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;"><br /></div></td><td colspan="2" style="background-color: #bec0bf; border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 11px; padding: 4px; width: 112px;" valign="top"><div align="center" style="text-align: center;"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;"><b>contentsOfDirectoryAtURL</b></span></div></td><td colspan="2" style="background-color: #bec0bf; border-color: rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 3px; height: 11px; padding: 4px; width: 109px;" valign="top"><div align="center" style="text-align: center;"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;"><b>getattrlistbulk</b></span></div></td><td colspan="2" style="background-color: #bec0bf; border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 11px; padding: 4px; width: 111px;" valign="top"><div align="center" style="text-align: center;"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;"><b>opendir/readdir</b></span></div></td></tr><tr><td style="background-color: #bec0bf; border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 78px;" valign="top"><div style="font-family: Helvetica; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;"><br /></div></td><td style="background-color: #bec0bf; border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 56px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;"><b>worst case</b></span></td><td style="background-color: #bec0bf; border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 10px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;"><b>best case</b></span></td><td style="background-color: #bec0bf; border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 10px; padding: 4px; width: 53px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;"><b>worst case</b></span></td><td style="background-color: #bec0bf; border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 10px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;"><b>best case</b></span></td><td style="background-color: #bec0bf; border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 10px; padding: 4px; width: 54px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;"><b>worst case</b></span></td><td style="background-color: #bec0bf; border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 48px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;"><b>best case</b></span></td></tr><tr><td style="background-color: gainsboro; border: 1px solid rgb(0, 0, 0); height: 11px; padding: 4px; width: 78px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;"><b>HD HFS+</b></span></td><td style="border: 1px solid rgb(0, 0, 0); height: 11px; padding: 4px; width: 56px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">12.4</span></td><td style="border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 11px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">2.8</span></td><td style="border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 11px; padding: 4px; width: 53px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">12.4</span></td><td style="background-color: #beffc1; border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 11px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">2.3</span></td><td style="border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 11px; padding: 4px; width: 54px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">12.4</span></td><td style="border: 1px solid rgb(0, 0, 0); height: 11px; padding: 4px; width: 48px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">2.35</span></td></tr><tr><td style="background-color: gainsboro; border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 78px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;"><b>SSD HFS+</b></span></td><td style="border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 56px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">4.9</span></td><td style="border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 10px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">2.8</span></td><td style="border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 10px; padding: 4px; width: 53px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">4.6</span></td><td style="background-color: #beffc1; border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 10px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">2.26</span></td><td style="border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 10px; padding: 4px; width: 54px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">4.6</span></td><td style="border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 48px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">2.47</span></td></tr><tr><td style="background-color: gainsboro; border: 1px solid rgb(0, 0, 0); height: 11px; padding: 4px; width: 78px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;"><b>SSD APFS</b></span></td><td style="border: 1px solid rgb(0, 0, 0); height: 11px; padding: 4px; width: 56px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">11.2</span></td><td style="border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 11px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">10.6</span></td><td style="border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 11px; padding: 4px; width: 53px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">10</span></td><td style="border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 11px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">6.8</span></td><td style="border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 11px; padding: 4px; width: 54px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">8.6</span></td><td style="background-color: #beffc1; border: 1px solid rgb(0, 0, 0); height: 11px; padding: 4px; width: 48px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">3.2</span></td></tr><tr><td style="background-color: gainsboro; border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 78px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;"><b>SSD NTFS</b></span></td><td style="border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 56px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">28</span></td><td style="border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 10px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">6</span></td><td style="border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 10px; padding: 4px; width: 53px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">28</span></td><td style="border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 10px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">6</span></td><td style="border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 10px; padding: 4px; width: 54px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">8</span></td><td style="background-color: #beffc1; border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 48px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">4.7</span></td></tr><tr><td style="background-color: gainsboro; border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 78px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;"><b>10.14 APFS</b></span></td><td style="border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 56px;" valign="top"><div style="font-family: Helvetica; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;"><br /></div></td><td style="border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 10px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">12</span></td><td style="border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 10px; padding: 4px; width: 53px;" valign="top"><div style="font-family: Helvetica; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;"><br /></div></td><td style="border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 10px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">10</span></td><td style="border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 10px; padding: 4px; width: 54px;" valign="top"><div style="font-family: Helvetica; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;"><br /></div></td><td style="background-color: #beffc1; border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 48px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">8</span></td></tr><tr><td style="background-color: gainsboro; border: 1px solid rgb(0, 0, 0); height: 11px; padding: 4px; width: 78px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;"><b>10.14 HFS+</b></span></td><td style="border: 1px solid rgb(0, 0, 0); height: 11px; padding: 4px; width: 56px;" valign="top"><div style="font-family: Helvetica; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;"><br /></div></td><td style="border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 11px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">4.1</span></td><td style="border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 11px; padding: 4px; width: 53px;" valign="top"><div style="font-family: Helvetica; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;"><br /></div></td><td style="background-color: #beffc1; border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 11px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">3.8</span></td><td style="border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 11px; padding: 4px; width: 54px;" valign="top"><div style="font-family: Helvetica; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;"><br /></div></td><td style="border: 1px solid rgb(0, 0, 0); height: 11px; padding: 4px; width: 48px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">4</span></td></tr><tr><td style="background-color: gainsboro; border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 78px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;"><b>NAS via AFP</b></span></td><td style="border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 56px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">5.6</span></td><td style="border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 10px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">2.5</span></td><td style="border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 10px; padding: 4px; width: 53px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">4.8</span></td><td style="background-color: #beffc1; border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 10px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">2.14</span></td><td style="border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 10px; padding: 4px; width: 54px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">5.6</span></td><td style="border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 48px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">2.7</span></td></tr><tr><td style="background-color: gainsboro; border: 1px solid rgb(0, 0, 0); height: 11px; padding: 4px; width: 78px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;"><b>NAS via SMB</b></span></td><td style="border: 1px solid rgb(0, 0, 0); height: 11px; padding: 4px; width: 56px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">15</span></td><td style="border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 11px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">15</span></td><td style="border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 11px; padding: 4px; width: 53px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">17</span></td><td style="border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 11px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">15</span></td><td style="border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 11px; padding: 4px; width: 54px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">9</span></td><td style="background-color: #beffc1; border: 1px solid rgb(0, 0, 0); height: 11px; padding: 4px; width: 48px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">5.7</span></td></tr><tr><td style="background-color: gainsboro; border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 78px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;"><b>Mac via SMB</b></span></td><td style="background-color: #ffd3de; border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 56px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">4.4</span></td><td style="border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 10px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">5.4</span></td><td style="border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 10px; padding: 4px; width: 53px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">6.8</span></td><td style="border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 10px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">5.5</span></td><td style="border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 10px; padding: 4px; width: 54px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">6.5</span></td><td style="border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 48px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">5</span></td></tr><tr><td style="background-color: gainsboro; border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 78px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;"><b>Mac via AFP</b></span></td><td style="border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 56px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">5.3</span></td><td style="border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 10px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">3.6</span></td><td style="border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 10px; padding: 4px; width: 53px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">5.1</span></td><td style="border-color: rgb(0, 0, 0) rgb(81, 81, 81) rgb(0, 0, 0) rgb(0, 0, 0); border-style: solid; border-width: 1px 3px 1px 1px; height: 10px; padding: 4px; width: 47px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">3.7</span></td><td style="border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) rgb(81, 81, 81); border-style: solid; border-width: 1px 1px 1px 3px; height: 10px; padding: 4px; width: 54px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">5.9</span></td><td style="border: 1px solid rgb(0, 0, 0); height: 10px; padding: 4px; width: 48px;" valign="top"><span style="color: black; font-family: &quot;helvetica neue&quot;; font-size: 10px; font-stretch: normal; line-height: normal;">4.3</span></td></tr></tbody></table></div><h3></h3><h3></h3><h3></h3><br /><h3>Observations</h3><div><ul><li>HD vs. SSD shows that the initial search takes much longer on HDs, which makes sense because HDs have a higher latency. Once the data is in the cache, though, both are equally fast (which makes sense as well).</li><li><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">contentsOfDirectoryAtURL&nbsp;</span>and&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">getattrlistbulk</span>&nbsp;perform equally indeed, just as predicted, with the latter usually being a bit faster once the data comes from the cache.</li><li><b>On APFS, NTFS and SMB, readdir() is significantly faster</b> than the other methods, which is quite surprising to me.</li><li><b>SMB performance is worse than AFP</b> (regardless, Apple declared AFP obsolete) in nearly all cases.</li><li>When accessing a Mac <b>via SMB,&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">contentsOfDirectoryAtURL</span>&nbsp;is faster</b> than the other methods, but only on the first run (see red field). Once the caches have been filled, it's slower. I can't make sense of it, but it's a very consistent effect in my tests.</li></ul><div><br /><h2>The fts functions</h2><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">fts_open()</span><span style="font-family: inherit;">&nbsp;/&nbsp;</span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">fts_read()</span><span style="font-family: inherit;">&nbsp;are, in most cases, faster than </span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">readdir()</span><span style="font-family: inherit;">,&nbsp;</span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">contentsOfDirectoryAtURL&nbsp;</span>and&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">getattrlistbulk.</span><span style="font-family: inherit;"> Exceptions are network protocols, where especially the retrieval of additional attributes makes it slower than the other methods.</span><br /><br /><h2>Fetching additional attributes</h2><div><br /></div><div>When extra attributes such as file dates or sizes, are needed during the scan, the timing of the various methods changes as follows:</div><div><br /></div><div><ul><li>For&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">contentsOfDirectoryAtURL&nbsp;</span>and&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">getattrlistbulk</span><span style="font-family: inherit;">, there is little impact if these extra attributes are requested with the function call.</span></li><li><span style="font-family: inherit;">For </span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">readdir()</span><span style="font-family: inherit;">, fetching additional attributes (through </span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">lstat()</span><span style="font-family: inherit;">) turns it into the slowest method.</span></li><li><span style="font-family: inherit;">The fts functions are the least affected by getting attributes that are also available through the&nbsp;</span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">lstat()</span><span style="font-family: inherit;"> function if a local file system is targeted. However, for network volumes via AFP, they become about 20% slower in my tests, whereas&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">getattrlistbulk</span>&nbsp;stays faster.</span></li></ul></div><div><br /></div><h2>Differences between macOS versions</h2><div><br /></div><div>When searching the same volumes (both HFS+ and APFS) from Sierra (10.12.6), High Sierra (10.13.6) and Mojave (10.14.4), I measure a consistent worse performance on Mojave. Meaning that scanning directories got <i>slower</i>&nbsp;in 10.14 vs. 10.13, by about 15%.</div><div><br /></div><div>Also, getting additional attributes 10.12, &nbsp;compared to 10.13 and later, takes about twice as long, across all methods. Which could mean that something improved in 10.13 regarding fetching attributes.</div><div><br /></div><h2>Conclusion</h2><br />It appears that for optimal performance, I need to implement several&nbsp;methods, and select them depending on which file system or protocol I talk to.<br /><br />Here's my current list of fastest method per file system:<br /><br /><ul><li>HFS+: Always&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">fts</span></li><li>APFS:&nbsp;Always&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">fts</span></li><li>AFP:&nbsp;Always&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">getattrlistbulk</span></li><li>SMB: If not attributes needed:&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">readdir</span><span style="font-family: inherit;">, otherwise </span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">fts</span><span style="font-family: inherit;"> or&nbsp;</span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">getattrlistbulk</span></li></ul><br /><h2>Update on 29 Apr 2019</h2><br />When traversing a directory tree, one must take care not to cross over into other volumes, which can happen if you encounted mounted file systems in your path, such as when you parse "/" into "/Volumes".<br /><br />The safe way to check for this is to determine the volume a folder is on before you dive into it. To identify volumes is to get their volume or device ID. One way is to call <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">stat()</span>, then check its <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">st_dev</span> value, another is to get the <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">NSURLVolumeIdentifierKey</span>. Or, in the case of <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">fts_read</span>, it's already provided - which adds to its superior efficiency.<br /><br />My testing shows an unpleasant performance impact, though:<br /><br />When traversing with&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">contentsOfDirectoryAtURL</span>, calling <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">stat()</span> is less efficient than getting the value for&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">NSURLVolumeIdentifierKey</span>. That makes sense, because the <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">stat()</span> fetches more data, and that could cause additional disk I/O.<br /><br />OTOH, the file system layer should know the ID of the volume without the need to perform disk I/O.<br /><br />Meaning, getting the value for&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">NSURLVolumeIdentifierKey</span>&nbsp;should cost no significant time at all, because the information is known to the upper file system level, before even passing the request on to the actual file system driver for the parcular volume. Therefore the value should be readily available at a much higher level - regardless, fetching this volume ID takes about as much time as getting an actual value from the lowest level, such as a file size or date.<br /><br />However, when I add fetching this volume ID to every encountered file &amp; folder, the scan time increases by over 30%. Fortunately, for the scanning, one only has to fetch this value for directories, not for files, which makes this have a smaller overall impact. Still, the performance of this could be better if Apple engineering would consider this, I believe. After all, identifying &nbsp;the volume ID is needed by almost any directory scanner.<br /><br /><h2>Update on 11 May 2019</h2><br />When discussing my findings on an Apple forum (actually, on one of the few remaining <a href="http://lists.apple.com/">Apple mailing lists</a>), Jim Luther pointed out to try <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">enumeratorAtURL</span>. And, indeed, this function does better than any of the others, at least with my tests on local disks, both on HFS+ and APFS. Like fts_read, it takes care of staying on the same volume, so that I do not have to check the volume ID myself.<br /><br />I have updated my test project with the use of this function.<br /><br /><h2>Comments, concerns?</h2></div></div><div><br />Feel free to download the <a href="http://files.tempel.org/Various/DirScanner.zip">Xcode project</a> and run your own tests.<br /><br />Comments are welcome here or on Twitter to me: @tempelorg</div><div><br /></div>